import Venda from "../Modelos/Venda.js";
import conectar from "./Conexao.js";
import Cliente from "../Modelos/Cliente.js";

export default class VendaDB {
    // async salvar(venda) {
    //     if (venda instanceof Venda) {
    //         const conexao = await conectar();
    //         const sql = "INSERT INTO venda (dataVenda, desconto, valorTotalTributos, cpfCliente) VALUES (?,?,?,?)";
    //         const valores = [
    //             venda.dataVenda,
    //             venda.desconto,
    //             venda.valorTotalTributos,
    //             venda.cliente.cpf];//nesse caso colocar que o cpf vai ser o direcionar a qual ciente é a venda, pois já temos cadastrados na tabela cliente o cpf do cliente
    //         const [result] = await conexao.query(sql, valores); //o "[result]" desestrutura a lista
    //         venda.id = result.insertId; //persiste com o id gerado no banco de dados
    //     }
    // }

    async salvar(venda) {
        if (venda instanceof Venda) {
            const conexao = await conectar();
            const sql = "INSERT INTO venda (dataVenda, desconto, valorTotalTributos, cpfCliente) VALUES (?,?,?,?)";
            const valores = [
                venda.dataVenda,
                venda.desconto,
                venda.valorTotalTributos,
                venda.cliente.cpf];//nesse caso colocar que o cpf vai ser o direcionar a qual ciente é a venda, pois já temos cadastrados na tabela cliente o cpf do cliente
            const [result] = await conexao.query(sql, valores); //o "[result]" desestrutura a lista
            venda.id = result.insertId; //persiste com o id gerado no banco de dados
        }
    }

    //sendo mais eficiente
    async consultar() {
        const conexao = await conectar();
        const sql = "SELECT * FROM venda INNER JOIN cliente ON venda.cpfCliente = cliente.cpf";
        const valores = [];
        const [rows] = await conexao.query(sql, valores);
        const listaVendas = [];
        // let cliente = {}
        // let venda = {}
        for (const registro of rows) {
            const cliente = new Cliente(
                registro['cpf'],
                registro['nome'],
                registro['sobrenome'],
                registro['usuario'],
                registro['cidade'],
                registro['uf'],
                registro['cep'],
                registro['endereco'],
                registro['bairro'],
                registro['telefone'],
                registro['email']);

            const venda = new Venda(
                registro["id"],
                registro["dataVenda"],
                registro["desconto"],
                registro["valorTotalTributos"],
                cliente);
            listaVendas.push(venda);
        }
        return listaVendas;
    }

    async consultarID(id) {
        const conexao = await conectar();
        const sql = "SELECT * FROM venda INNER JOIN cliente ON venda.cpfCliente = cliente.cpf WHERE venda.id=?";
        const valores = [id];
        const [rows] = await conexao.query(sql, valores);
        let listaVendas = [];
        for (const registro of rows) {
            const cliente = new Cliente(
                registro['cpf'],
                registro['nome'],
                registro['sobrenome'],
                registro['usuario'],
                registro['cidade'],
                registro['uf'],
                registro['cep'],
                registro['endereco'],
                registro['bairro'],
                registro['telefone'],
                registro['email']);

            const venda = new Venda(
                registro["id"],
                registro["dataVenda"],
                registro["desconto"],
                registro["valorTotalTributos"],
                cliente);
            listaVendas.push(venda);
        }
        return listaVendas;
    }
}